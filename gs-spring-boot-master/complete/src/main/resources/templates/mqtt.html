<!DOCTYPE html>
<html>
<head>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <style media="screen">
    body{
      font-family: 'Roboto', sans-serif;
    }

    h1{
      margin: 15px;
    }

    button{
      height: 40px;
    }

    .enlinea{
      display: inline;
      width: auto;
    }

    .boton{
      width: 100px;
      border-style: dotted;
      text-align: center;
      display: table-cell;
      vertical-align: middle;
      margin: 8px 8px;
    }

    .botonera{
      margin: 15px;
    }

    .contenedor{
      margin: 15px;
      height: 100px;
      width: 400px;
      background-color:#CCC;
      display: flex;
      justify-content: space-around;
    }

    .alerta{
      display: none;
      background-color: indianred;
      border: solid darkred 2px;
      color: darkred;
      text-align: center;
    }

    input{
      height: 100%;
      align-content: center;
      width: 100%;
      padding: 12px 20px;
      margin: auto;
      display: inline-block;
      border: 1px solid #ffffff;
      border-radius: 4px;
      box-sizing: border-box;
    }

    #showImage{
      margin: 15px;
      margin-top: 0px;
    }

    #twinImg{
      display: none;
    }

  </style>

</head>
<body>
<script>
  $(document).ready(rellamar());

  function rellamar(){
    setInterval(function(){
      getSensoresYEstado();
      updateImage();
    }, 1000);
  }

  function updateImage(){
    var xhr = new XMLHttpRequest();

    xhr.open('GET',"/img/getImage", true);

    xhr.onload = function(){
      var img = new Image();
      var response = xhr.responseText;
      var binary = "";

      for(i=0;i<response.length;i++){
        binary += String.fromCharCode(response.charCodeAt(i) & 0xff);
      }

      img.src = 'data:image/jpeg;base64,' + btoa(binary);
      var canvas = document.getElementById('showImage');
      var context = canvas.getContext('2d');

      context.drawImage(img,0,0);
      var snapshot = canvas.toDataURL("image/png");
      var twinImage = document.getElementById('twinImg');
      twinImage.src = snapshot;

    };

    xhr.overrideMimeType('text/plain; charset=x-user-defined');
    xhr.send();
  }

  function getSensoresYEstado() {
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
      if (this.readyState === 4 && this.status === 200) {
        var arrrayDeNumeros = this.responseText.split(";");
        document.getElementById("sensorA").value = arrrayDeNumeros[0];
        document.getElementById("sensorB").value = arrrayDeNumeros[1];
        document.getElementById("sensorC").value = arrrayDeNumeros[2];
        document.getElementById("estado").innerHTML = arrrayDeNumeros[3];

        if (arrrayDeNumeros[3] === "alr"){
          document.getElementById("alert").style.display = "block";
        }else{
          document.getElementById("alert").style.display = "none";
        }
      }};
    xhttp.open("GET", "mqtt?dato=A", true);
    xhttp.send();
  }

  // Si el parámetro estado vale 1 (ascii = 49), se activa el arduino. Si se envía 2 (ascii = 50), se desactivan los sensores.
  function send(estado) {
    var xhttp = new XMLHttpRequest();
    xhttp.open("GET","send?estado=" + estado ,true);
    xhttp.send();
  }

</script>
  <h1>Servidor Arduino-Raspberry</h1>
  <div style="display: flex">
    <div>
      <h1>Cámara:</h1>
      <canvas id="showImage" width="640" height="480"></canvas>
      <img src="#" id="twinImg"/>
    </div>
    <div>
      <div>
        <h1>Distancia sensores:</h1>
        <div class="contenedor">
          <div class="boton">
            <input type="text" id="sensorA" disabled="true">
          </div>
          <div class="boton">
            <input type="text" id="sensorB" disabled="true">
          </div>
          <div class="boton">
            <input type="text" id="sensorC" disabled="true">
          </div>
        </div>
      </div>
      <div>
        <h1 class="enlinea" >Servicio:</h1>
        <h1 id="estado" class="enlinea"></h1>
        <div class="botonera">
          <button onclick='send("1")' style="background-color: green">Encendido</button>
          <button onclick='send("2")' style="background-color: darkred">Apagado</button>
          <button onclick='send("3")' style="background-color: darkgoldenrod">Manual</button>
        </div>
      </div>
      <div class="alerta" id="alert">
        <p>Se ha detectado movimiento</p>
      </div>
    </div>
  </div>


</body>
</html>
